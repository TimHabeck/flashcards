<!-- 
  Anki Card Scripts
  -----------------
  Copy the following code and paste it at the bottom of your 
  "Back Template" (and "Front Template" if you have diagrams there) 
  in the Anki Note Type editor.
-->

<script type="module">
  /**
   * Robust Mermaid.js Loader for Anki
   * This script ensures Mermaid diagrams are rendered correctly across 
   * Anki Desktop, AnkiMobile (iOS), and AnkiDroid (Android).
   */
  async function renderMermaid() {
    try {
      // 1. Check for Mermaid containers
      const elements = document.querySelectorAll('.mermaid');
      if (elements.length === 0) return;

      // 2. Load Mermaid from CDN if not already present
      if (typeof mermaid === 'undefined') {
        const { default: mermaidLib } = await import('https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs');
        window.mermaid = mermaidLib;
        mermaid.initialize({ 
          startOnLoad: false, // We control the rendering manually
          theme: 'default',
          securityLevel: 'loose'
        });
      }

      // 3. Run rendering
      await window.mermaid.run();
    } catch (e) {
      console.error("Mermaid rendering error:", e);
    }
  }

  // Execute on load
  renderMermaid();
</script>
